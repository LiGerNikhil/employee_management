{% extends 'layout/blank.html' %}
{% load static %}

{% block title %}Register Your Face{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Face Registration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="video-container mb-3">
                                <video id="video" width="100%" height="auto" autoplay></video>
                            </div>
                            <div class="text-center">
                                <button id="capture" class="btn btn-primary">Capture & Register Face</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Instructions</h5>
                                </div>
                                <div class="card-body">
                                    <ol>
                                        <li>Position yourself in a well-lit area</li>
                                        <li>Look directly at the camera</li>
                                        <li>Make sure your face is clearly visible</li>
                                        <li>Click 'Capture & Register Face' to take a photo</li>
                                        <li>Wait for confirmation that your face has been registered</li>
                                    </ol>
                                    <div id="previewContainer" class="text-center d-none">
                                        <h6>Preview</h6>
                                        <img id="preview" class="img-fluid rounded" style="max-width: 200px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('capture');
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('previewContainer');
        let stream = null;

        // Access the webcam
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user' 
                    },
                    audio: false 
                });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing the camera: ", err);
                alert("Error accessing the camera. Please make sure you've granted camera permissions.");
            }
        }

        // Capture image from video stream
        captureBtn.addEventListener('click', function() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Show preview
            preview.src = canvas.toDataURL('image/jpeg');
            previewContainer.classList.remove('d-none');
            
            // Send to server
            registerFace(canvas.toDataURL('image/jpeg'));
        });

        // Send the captured image to the server
        async function registerFace(imageData) {
            try {
                const response = await fetch('{% url "employees:face_register" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `image=${encodeURIComponent(imageData)}`
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Face registered successfully!');
                    if (result.profile_picture) {
                        // Update profile picture preview if available
                        document.querySelector('.user-avatar').src = result.profile_picture;
                    }
                } else {
                    alert('Error: ' + (result.error || 'Failed to register face'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while registering your face.');
            }
        }

        // Start the camera when the page loads
        startCamera();

        // Clean up the stream when the page is unloaded
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    });
</script>
{% endblock %}
