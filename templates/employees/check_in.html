{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Attendance | Kwikster CRM{% endblock %}

{% block content %}
  <style>
    .attn-message {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.85rem 1rem;
      border-radius: 14px;
      margin-bottom: 0.75rem;
      background: rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 0.95rem;
      color: #1f2937;
    }

    .attn-message:last-child {
      margin-bottom: 0;
    }

    .attn-message__badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      background: rgba(30, 64, 175, 0.08);
      color: #1d4ed8;
    }

    .attn-message--success {
      background: rgba(16, 185, 129, 0.08);
      border-color: rgba(5, 150, 105, 0.4);
      color: #065f46;
    }

    .attn-message--success .attn-message__badge {
      background: rgba(16, 185, 129, 0.16);
      color: #047857;
    }

    .attn-message--warning {
      background: rgba(249, 115, 22, 0.1);
      border-color: rgba(234, 88, 12, 0.35);
      color: #9a3412;
    }

    .attn-message--warning .attn-message__badge {
      background: rgba(249, 115, 22, 0.18);
      color: #ea580c;
    }

    .attn-message--error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(220, 38, 38, 0.4);
      color: #991b1b;
    }

    .attn-message--error .attn-message__badge {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
    }

    .attn-message--info {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(37, 99, 235, 0.35);
      color: #1e3a8a;
    }

    .attn-message--info .attn-message__badge {
      background: rgba(59, 130, 246, 0.15);
      color: #1d4ed8;
    }

    .today-attendance-card {
      width: 100%;
      max-width: 420px;
      margin: 0.75rem auto 0;
      padding: 1.1rem 1.25rem;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.18) 0%, rgba(16, 185, 129, 0.12) 100%);
      border: 1px solid rgba(34, 197, 94, 0.28);
      text-align: left;
      color: #065f46;
      box-shadow: 0 14px 30px rgba(16, 185, 129, 0.15);
    }

    .today-attendance-card__header {
      display: flex;
      align-items: center;
      gap: 0.9rem;
      margin-bottom: 1rem;
    }

    .today-attendance-card__icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(34, 197, 94, 0.18);
      display: grid;
      place-items: center;
      font-size: 1.4rem;
      color: #0f766e;
    }

    .today-attendance-card__titles {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .today-attendance-card__label {
      font-weight: 700;
      font-size: 1rem;
      letter-spacing: 0.01em;
    }

    .today-attendance-card__date {
      font-size: 0.85rem;
      color: #0f766e;
    }

    .today-attendance-card__body {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .today-attendance-card__item {
      flex: 1 1 calc(50% - 0.75rem);
      min-width: 140px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
      padding: 0.7rem 0.9rem;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.55);
    }

    .today-attendance-card__item .item-label {
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #047857;
    }

    .today-attendance-card__item .item-value {
      font-size: 1.05rem;
      font-weight: 700;
      color: #064e3b;
    }

    .primary-action-stack {
      display: flex;
      justify-content: center;
      margin: 1.05rem 0 1rem;
    }

    .primary-action-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.45rem;
      min-width: 180px;
      padding: 0.75rem 1.1rem;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 18px;
      border: none;
      color: #fff;
      background: linear-gradient(135deg, #60a5fa, #2563eb);
      box-shadow: 0 18px 38px rgba(37, 99, 235, 0.25);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .primary-action-button--checkin {
      background: linear-gradient(135deg, #34d399, #059669);
      box-shadow: 0 16px 32px rgba(16, 185, 129, 0.24);
    }

    .primary-action-button--checkout {
      background: linear-gradient(135deg, #f97316, #ef4444);
      box-shadow: 0 16px 32px rgba(249, 115, 22, 0.24);
    }

    .primary-action-button i {
      font-size: 1.05rem;
    }

    .primary-action-button:hover,
    .primary-action-button:focus {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(15, 118, 110, 0.2);
    }

    .primary-action-button--checkout:hover,
    .primary-action-button--checkout:focus {
      box-shadow: 0 14px 26px rgba(239, 68, 68, 0.22);
    }

    .secondary-actions {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.6rem;
      margin-bottom: 1.1rem;
    }

    .action-pill {
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      width: 70px;
      height: 70px;
      padding: 0.55rem;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.68rem;
      letter-spacing: 0.02em;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      border: none;
      text-align: center;
    }

    .action-pill i {
      font-size: 1.15rem;
    }

    .action-pill__label {
      display: block;
      line-height: 1.1;
    }

    .action-pill--dashboard {
      color: #fff;
      background: linear-gradient(135deg, #6366f1, #4338ca);
      box-shadow: 0 10px 22px rgba(99, 102, 241, 0.22);
    }

    .action-pill--profile {
      color: #4338ca;
      background: rgba(99, 102, 241, 0.12);
      border: 1px solid rgba(99, 102, 241, 0.22);
      box-shadow: 0 8px 18px rgba(99, 102, 241, 0.12);
    }

    .action-pill:hover,
    .action-pill:focus {
      transform: translateY(-2px);
    }

    @media (max-width: 576px) {
      .attn-message {
        flex-direction: column;
        align-items: flex-start;
      }

      .today-attendance-card {
        padding: 1rem;
        border-radius: 18px;
      }

      .today-attendance-card__body {
        flex-direction: column;
        gap: 0.55rem;
      }

      .today-attendance-card__item {
        width: 100%;
      }

      .primary-action-button {
        min-width: 85%;
        width: auto;
        padding: 0.7rem 1rem;
        font-size: 0.92rem;
        box-shadow: 0 14px 30px rgba(15, 118, 110, 0.22);
      }

      .secondary-actions {
        gap: 0.45rem;
      }

      .action-pill {
        flex: 0 0 64px;
        width: 64px;
        height: 64px;
        border-radius: 18px;
        padding: 0.45rem;
      }
    }

    .attendance-shell {
      border-radius: 28px;
      overflow: hidden;
      border: none;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
      animation: slideInSoft 420ms ease-out;
    }

    @keyframes slideInSoft {
      0% {
        transform: translateY(18px);
        opacity: 0;
      }
      60% {
        transform: translateY(-6px);
        opacity: 1;
      }
      100% {
        transform: translateY(0);
      }
    }

    .attendance-shell .card-header {
      border-top-left-radius: 28px;
      border-top-right-radius: 28px;
      border-bottom: 1px solid rgba(226, 232, 240, 0.7);
      background: rgba(15, 23, 42, 0.02);
    }

    .attendance-shell .card-body {
      border-bottom-left-radius: 28px;
      border-bottom-right-radius: 28px;
    }

    @media (max-width: 576px) {
      .attendance-shell {
        border-radius: 22px;
      }

      .attendance-shell .card-header {
        border-top-left-radius: 22px;
        border-top-right-radius: 22px;
      }

      .attendance-shell .card-body {
        border-bottom-left-radius: 22px;
        border-bottom-right-radius: 22px;
      }
    }

</style>

  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10 col-md-12">
      <div class="card attendance-shell">
        <div class="card-header text-center">
          <h5 class="card-title m-0">Attendance Management</h5>
          <small class="text-muted">Manage your daily check-in and check-out</small>
        </div>

        {% if messages %}
          <div class="px-4 pt-3">
            {% for message in messages %}
              <div class="attn-message attn-message--{{ message.tags|default:'info' }}">
                <span class="attn-message__badge">
                  {% if 'success' in message.tags %}<i class="bx bx-check-circle"></i>{% elif 'warning' in message.tags %}<i class="bx bx-error"></i>{% elif 'error' in message.tags %}<i class="bx bx-x-circle"></i>{% else %}<i class="bx bx-info-circle"></i>{% endif %}
                  {{ message.tags|default:'Info'|title }}
                </span>
                <span class="attn-message__text">{{ message }}</span>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <div class="text-center mb-4">
          <div class="avatar avatar-xl mb-3 mx-auto">
            {% if employee.profile_picture %}
              <img src="{{ employee.profile_picture.url }}" alt="{{ employee.name }}" class="rounded-circle">
            {% else %}
              <span class="avatar-initial rounded-circle bg-label-primary">
                {{ employee.name|slice:":1"|upper }}
              </span>
            {% endif %}
          </div>
          <h4 class="mb-2">Welcome, {{ employee.name }}!</h4>
          <p class="text-muted mb-4">
            Manage your attendance and view your monthly calendar
          </p>

          {% if today_attendance %}
            <div class="today-attendance-card">
              <div class="today-attendance-card__header">
                <span class="today-attendance-card__icon"><i class="bx bx-check"></i></span>
                <div class="today-attendance-card__titles">
                  <span class="today-attendance-card__label">Today's Attendance</span>
                  <span class="today-attendance-card__date">{{ today_attendance.date|date:"d M Y, l" }}</span>
                </div>
              </div>
              <div class="today-attendance-card__body">
                <div class="today-attendance-card__item">
                  <span class="item-label">Date</span>
                  <span class="item-value">{{ today_attendance.date|date:"d M Y" }}</span>
                </div>
                <div class="today-attendance-card__item">
                  <span class="item-label">Check-in</span>
                  <span class="item-value">{{ today_attendance.check_in_time|date:"H:i:s" }}</span>
                </div>
                {% if today_attendance.check_out_time %}
                  <div class="today-attendance-card__item">
                    <span class="item-label">Check-out</span>
                    <span class="item-value">{{ today_attendance.check_out_time|date:"H:i:s" }}</span>
                  </div>
                {% endif %}
              </div>
            </div>
          {% endif %}

          <!-- Action Buttons -->
          <div class="primary-action-stack">
            {% if not has_checked_in_today %}
              <button type="button" class="primary-action-button primary-action-button--checkin" data-bs-toggle="modal" data-bs-target="#checkinModal">
                <i class="bx bx-log-in"></i>
                <span>Check In</span>
              </button>
            {% elif today_attendance and not today_attendance.check_out_time %}
              <button type="button" class="primary-action-button primary-action-button--checkout" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                <i class="bx bx-log-out"></i>
                <span>Check Out</span>
              </button>
            {% else %}
              <div class="alert alert-info w-100 mx-4">
                <i class="bx bx-info-circle me-1"></i>
                You have completed your attendance for today.
              </div>
            {% endif %}
          </div>

          <!-- Navigation Buttons -->
          <div class="secondary-actions">
            <a href="{% url 'employees:employee_dashboard' %}" class="action-pill action-pill--dashboard">
              <i class="bx bx-home"></i>
              <span>Dashboard</span>
            </a>
            <a href="{% url 'employees:employee_profile' %}" class="action-pill action-pill--profile">
              <i class="bx bx-user"></i>
              <span>Profile</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Check-In Modal -->
  <div class="modal fade" id="checkinModal" tabindex="-1" aria-labelledby="checkinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title text-white" id="checkinModalLabel">
            <i class="bx bx-log-in me-2"></i>Check In
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bx bx-camera me-1"></i>
            <strong>Photo Verification Required:</strong> Please capture a photo to complete your check-in.
          </div>

          <div class="text-center">
            <div class="camera-container mb-3">
              <video id="checkin-camera" class="camera-preview" autoplay playsinline muted style="display: none;"></video>
              <canvas id="checkin-canvas" class="d-none"></canvas>
              <img id="checkin-preview" class="camera-preview d-none" alt="Preview">
            </div>

            <div class="mb-3">
              <button type="button" id="checkin-capture-btn" class="btn btn-success btn-lg" disabled>
                <i class="bx bx-camera me-1"></i>Capture Photo
              </button>
              <button type="button" id="checkin-retake-btn" class="btn btn-outline-secondary btn-lg d-none">
                <i class="bx bx-refresh me-1"></i>Retake
              </button>
            </div>

            <div id="checkin-camera-status" class="text-muted small mb-3">
              <i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...
            </div>
          </div>

          <form id="checkin-form" method="post" enctype="multipart/form-data" class="d-none">
            {% csrf_token %}
            <input type="file" name="check_in_photo" id="checkin-photo-input" accept="image/*" required class="d-none">
            <input type="hidden" name="latitude" id="checkin-latitude-input">
            <input type="hidden" name="longitude" id="checkin-longitude-input">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bx bx-x me-1"></i>Cancel
          </button>
          <button type="button" id="checkin-submit-btn" class="btn btn-success" disabled>
            <i class="bx bx-check-circle me-1"></i>Complete Check-In
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Check-Out Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title text-white" id="checkoutModalLabel">
            <i class="bx bx-log-out me-2"></i>Check Out
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bx bx-camera me-1"></i>
            <strong>Photo Verification Required:</strong> Please capture a photo to complete your check-out.
          </div>

          <div class="text-center">
            <div class="camera-container mb-3">
              <video id="checkout-camera" class="camera-preview" autoplay playsinline muted style="display: none;"></video>
              <canvas id="checkout-canvas" class="d-none"></canvas>
              <img id="checkout-preview" class="camera-preview d-none" alt="Preview">
            </div>

            <div class="mb-3">
              <button type="button" id="checkout-capture-btn" class="btn btn-danger btn-lg" disabled>
                <i class="bx bx-camera me-1"></i>Capture Photo
              </button>
              <button type="button" id="checkout-retake-btn" class="btn btn-outline-secondary btn-lg d-none">
                <i class="bx bx-refresh me-1"></i>Retake
              </button>

            </div>

            <div id="checkout-camera-status" class="text-muted small mb-3">
              <i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...
            </div>
          </div>

          <form id="checkout-form" method="post" action="{% url 'employees:check_out' %}" enctype="multipart/form-data" class="d-none">
            {% csrf_token %}
            <input type="file" name="check_out_photo" id="checkout-photo-input" accept="image/*" required class="d-none">
            <input type="hidden" name="latitude" id="checkout-latitude-input">
            <input type="hidden" name="longitude" id="checkout-longitude-input">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bx bx-x me-1"></i>Cancel
          </button>
          <button type="button" id="checkout-submit-btn" class="btn btn-danger" disabled>
            <i class="bx bx-log-out me-1"></i>Complete Check-Out
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // ===========================
    // CHECK-IN MODAL FUNCTIONALITY
    // ===========================
    const checkinModal = document.getElementById('checkinModal');
    const checkinCamera = document.getElementById('checkin-camera');
    const checkinCanvas = document.getElementById('checkin-canvas');
    const checkinPreview = document.getElementById('checkin-preview');
    const checkinCaptureBtn = document.getElementById('checkin-capture-btn');
    const checkinRetakeBtn = document.getElementById('checkin-retake-btn');
    const checkinUploadBtn = document.getElementById('checkin-upload-btn');
    const checkinSubmitBtn = document.getElementById('checkin-submit-btn');
    const checkinForm = document.getElementById('checkin-form');
    const checkinPhotoInput = document.getElementById('checkin-photo-input');
    const checkinCameraStatus = document.getElementById('checkin-camera-status');
    const checkinLatitudeInput = document.getElementById('checkin-latitude-input');
    const checkinLongitudeInput = document.getElementById('checkin-longitude-input');
    
    let checkinStream = null;
    let checkinPhotoBlob = null;
    let checkinPreviewUrl = null;

    function describeCameraError(error) {
        if (!error) {
            return 'Camera access failed for an unknown reason.';
        }
        const name = error.name || '';
        const message = error.message || '';
        switch (name) {
            case 'NotAllowedError':
            case 'PermissionDeniedError':
                return 'Camera permission was denied. Please allow camera access in your browser settings and try again.';
            case 'NotFoundError':
            case 'DevicesNotFoundError':
                return 'No camera device was found. Connect a camera and try again.';
            case 'NotReadableError':
            case 'TrackStartError':
                return 'The camera is already in use by another application. Close other programs using the camera and retry.';
            case 'OverconstrainedError':
            case 'ConstraintNotSatisfiedError':
                return 'The requested camera settings are not supported. We will try a more compatible setup automatically.';
            case 'SecurityError':
                if (window.isSecureContext === false) {
                    return 'Camera access requires HTTPS or localhost. Please use a secure connection.';
                }
                return 'Camera access is blocked by browser security settings.';
            default:
                if (message && message.toLowerCase().includes('insecure')) {
                    return 'Camera access requires HTTPS or localhost. Please reload the page over a secure connection.';
                }
                return message || 'Unable to access camera. Please allow permissions and try again.';
        }
    }

    async function acquireCameraStream() {
        const attempts = [
            { video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }, audio: false },
            { video: { facingMode: 'user' }, audio: false },
            { video: true }
        ];

        let lastError = null;
        for (const constraints of attempts) {
            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                lastError = err;
            }
        }
        throw lastError;
    }

    // Get user's current location for check-in
    function getCheckinLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation is not supported by your browser'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    let errorMessage = 'Unable to retrieve your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    reject(new Error(errorMessage));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }
    
    // Initialize camera when modal is shown
    if (checkinModal) {
        checkinModal.addEventListener('shown.bs.modal', function() {
            // Kick off camera immediately
            initCheckinCamera();

            // Request location in parallel
            getCheckinLocation()
                .then(coords => {
                    checkinLatitudeInput.value = coords.latitude;
                    checkinLongitudeInput.value = coords.longitude;
                    console.log('Check-in location obtained:', coords);
                })
                .catch(error => {
                    console.error('Location error:', error);
                    alert(error.message + '\n\nLocation access is required for check-in. Please enable location services and try again.');
                });
        });
        
        checkinModal.addEventListener('hidden.bs.modal', function() {
            stopCheckinCamera();
            resetCheckinModal();
        });
    }
    
    async function initCheckinCamera() {
        console.log('Initializing check-in camera...');

        if (!window.isSecureContext) {
            const msg = 'Camera access requires HTTPS or running the site on localhost. Please reload via https:// or http://localhost.';
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
            console.error(msg);
            checkinCaptureBtn.disabled = true;
            return;
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('MediaDevices API not supported');
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Camera not supported on this device';
            checkinCaptureBtn.disabled = true;
            return;
        }

        if (navigator.permissions && navigator.permissions.query) {
            try {
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    const msg = 'Browser camera permission is blocked. Please enable camera access in your browser settings and reload the page.';
                    checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
                    checkinCaptureBtn.disabled = true;
                    return;
                }
            } catch (permErr) {
                console.warn('Unable to query camera permissions:', permErr);
            }
        }

        checkinCaptureBtn.disabled = true;
        checkinCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Requesting camera access...';

        try {
            // Stop existing stream before requesting a new one
            stopCheckinCamera();

            const stream = await acquireCameraStream();

            checkinStream = stream;
            checkinCamera.srcObject = stream;
            checkinCamera.style.display = 'block';
            
            // Force play immediately
            try {
                await checkinCamera.play();
                console.log('Check-in camera playing');
                checkinCaptureBtn.disabled = false;
                checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
            } catch (playError) {
                console.error('Error playing camera:', playError);
                // Try one more time after a short delay
                setTimeout(async () => {
                    try {
                        await checkinCamera.play();
                        checkinCaptureBtn.disabled = false;
                        checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
                    } catch (e) {
                        checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Error starting camera';
                    }
                }, 500);
            }
        } catch (error) {
            console.error('Camera error:', error.name, error.message, error);
            const errorMsg = describeCameraError(error);
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + errorMsg;
            checkinCaptureBtn.disabled = true;
        }
    }
    
    function stopCheckinCamera() {
        if (checkinStream) {
            checkinStream.getTracks().forEach(track => track.stop());
            checkinStream = null;
        }
    }
    
    function resetCheckinModal() {
        if (checkinPreviewUrl) {
            URL.revokeObjectURL(checkinPreviewUrl);
            checkinPreviewUrl = null;
        }
        checkinCamera.style.display = 'none';
        checkinPreview.classList.add('d-none');
        checkinCaptureBtn.classList.remove('d-none');
        checkinRetakeBtn.classList.add('d-none');
        checkinSubmitBtn.disabled = true;
        checkinPhotoBlob = null;
        checkinPhotoInput.value = '';
        // Clear location values
        checkinLatitudeInput.value = '';
        checkinLongitudeInput.value = '';
        checkinCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...';
    }
    
    // Capture photo
    if (checkinCaptureBtn) {
        checkinCaptureBtn.addEventListener('click', function() {
            const context = checkinCanvas.getContext('2d');
            checkinCanvas.width = checkinCamera.videoWidth;
            checkinCanvas.height = checkinCamera.videoHeight;
            context.drawImage(checkinCamera, 0, 0);
            
            checkinCanvas.toBlob(function(blob) {
                checkinPhotoBlob = blob;
                if (checkinPreviewUrl) {
                    URL.revokeObjectURL(checkinPreviewUrl);
                }
                checkinPreviewUrl = URL.createObjectURL(blob);
                checkinPreview.src = checkinPreviewUrl;
                
                // Hide camera, show preview
                checkinCamera.style.display = 'none';
                checkinPreview.classList.remove('d-none');
                checkinCaptureBtn.classList.add('d-none');
                checkinRetakeBtn.classList.remove('d-none');
                checkinSubmitBtn.disabled = false;
                checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo captured successfully';
                
                // Stop camera
                stopCheckinCamera();
            }, 'image/jpeg', 0.8);
        });
    }
    
    // Retake photo
    if (checkinRetakeBtn) {
        checkinRetakeBtn.addEventListener('click', function() {
            checkinPreview.classList.add('d-none');
            checkinCamera.style.display = 'block';
            checkinCaptureBtn.classList.remove('d-none');
            checkinRetakeBtn.classList.add('d-none');
            checkinSubmitBtn.disabled = true;
            checkinPhotoBlob = null;
            if (checkinPreviewUrl) {
                URL.revokeObjectURL(checkinPreviewUrl);
                checkinPreviewUrl = null;
            }
            checkinPhotoInput.value = '';
            initCheckinCamera();
        });
    }

    if (checkinUploadBtn) {
        checkinUploadBtn.addEventListener('click', function() {
            stopCheckinCamera();
            checkinCaptureBtn.classList.add('d-none');
            checkinCamera.style.display = 'none';
            checkinRetakeBtn.classList.remove('d-none');
            checkinCameraStatus.innerHTML = '<i class="bx bx-upload me-1"></i>Select a photo using your device camera or gallery.';
            checkinPhotoInput.click();
        });
    }

    if (checkinPhotoInput) {
        checkinPhotoInput.addEventListener('change', function(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }

            checkinPhotoBlob = file;
            if (checkinPreviewUrl) {
                URL.revokeObjectURL(checkinPreviewUrl);
            }
            checkinPreviewUrl = URL.createObjectURL(file);
            checkinPreview.src = checkinPreviewUrl;
            checkinPreview.classList.remove('d-none');
            checkinSubmitBtn.disabled = false;
            checkinRetakeBtn.classList.remove('d-none');
            checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo selected successfully.';
        });
    }
    
    // Submit check-in
    if (checkinSubmitBtn) {
        checkinSubmitBtn.addEventListener('click', function() {
            console.log('Check-in submit clicked');
            console.log('Photo blob:', checkinPhotoBlob);
            console.log('Latitude:', checkinLatitudeInput.value);
            console.log('Longitude:', checkinLongitudeInput.value);
            
            if (!checkinPhotoBlob) {
                alert('Please capture a photo first');
                return;
            }
            
            // Validate location coordinates are present
            if (!checkinLatitudeInput.value || !checkinLongitudeInput.value) {
                console.error('Location validation failed - coordinates missing');
                alert('Location access is required for check-in. Please enable location services and try again.');
                return;
            }
            
            // Create file from blob
            let fileToSubmit;
            if (checkinPhotoBlob instanceof File) {
                fileToSubmit = checkinPhotoBlob;
            } else {
                fileToSubmit = new File([checkinPhotoBlob], 'checkin_photo.jpg', { type: 'image/jpeg' });
            }
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(fileToSubmit);
            checkinPhotoInput.files = dataTransfer.files;
            
            console.log('Submitting check-in form with location:', {
                latitude: checkinLatitudeInput.value,
                longitude: checkinLongitudeInput.value
            });
            
            // Disable button and show loading
            checkinSubmitBtn.disabled = true;
            checkinSubmitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Processing...';
            
            // Submit form
            checkinForm.submit();
        });
    }

    // ===========================
    // CHECK-OUT MODAL FUNCTIONALITY
    // ===========================
    const checkoutModal = document.getElementById('checkoutModal');
    const checkoutCamera = document.getElementById('checkout-camera');
    const checkoutCanvas = document.getElementById('checkout-canvas');
    const checkoutPreview = document.getElementById('checkout-preview');
    const checkoutCaptureBtn = document.getElementById('checkout-capture-btn');
    const checkoutRetakeBtn = document.getElementById('checkout-retake-btn');
    const checkoutUploadBtn = document.getElementById('checkout-upload-btn');
    const checkoutSubmitBtn = document.getElementById('checkout-submit-btn');
    const checkoutForm = document.getElementById('checkout-form');
    const checkoutPhotoInput = document.getElementById('checkout-photo-input');
    const checkoutCameraStatus = document.getElementById('checkout-camera-status');
    const checkoutLatitudeInput = document.getElementById('checkout-latitude-input');
    const checkoutLongitudeInput = document.getElementById('checkout-longitude-input');
    
    let checkoutStream = null;
    let checkoutPhotoBlob = null;
    let checkoutPreviewUrl = null;
    
    // Get user's current location for checkout
    function getCheckoutLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation is not supported by your browser'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    let errorMessage = 'Unable to retrieve your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    reject(new Error(errorMessage));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }
    
    // Initialize camera when modal is shown
    if (checkoutModal) {
        checkoutModal.addEventListener('shown.bs.modal', function() {
            // Start camera immediately
            initCheckoutCamera();

            // Request location concurrently
            getCheckoutLocation()
                .then(coords => {
                    checkoutLatitudeInput.value = coords.latitude;
                    checkoutLongitudeInput.value = coords.longitude;
                    console.log('Checkout location obtained:', coords);
                })
                .catch(error => {
                    console.error('Location error:', error);
                    alert(error.message + '\n\nLocation access is required for check-out. Please enable location services and try again.');
                });
        });
        
        checkoutModal.addEventListener('hidden.bs.modal', function() {
            stopCheckoutCamera();
            resetCheckoutModal();
        });
    }
    
    async function initCheckoutCamera() {
        console.log('Initializing checkout camera...');

        if (!window.isSecureContext) {
            const msg = 'Camera access requires HTTPS or running the site on localhost. Please reload via https:// or http://localhost.';
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
            console.error(msg);
            checkoutCaptureBtn.disabled = true;
            return;
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('MediaDevices API not supported');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Camera not supported on this device';
            checkoutCaptureBtn.disabled = true;
            return;
        }

        if (navigator.permissions && navigator.permissions.query) {
            try {
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    const msg = 'Browser camera permission is blocked. Please enable camera access in your browser settings and reload the page.';
                    checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
                    checkoutCaptureBtn.disabled = true;
                    return;
                }
            } catch (permErr) {
                console.warn('Unable to query camera permissions:', permErr);
            }
        }

        checkoutCaptureBtn.disabled = true;
        checkoutCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Requesting camera access...';

        try {
            // Stop existing stream to avoid conflicts
            stopCheckoutCamera();

            const stream = await acquireCameraStream();

            checkoutStream = stream;
            checkoutCamera.srcObject = stream;
            checkoutCamera.style.display = 'block';
            
            // Force play immediately
            try {
                await checkoutCamera.play();
                console.log('Checkout camera playing');
                checkoutCaptureBtn.disabled = false;
                checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
            } catch (playError) {
                console.error('Error playing camera:', playError);
                // Try one more time after a short delay
                setTimeout(async () => {
                    try {
                        await checkoutCamera.play();
                        checkoutCaptureBtn.disabled = false;
                        checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
                    } catch (e) {
                        checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Error starting camera';
                    }
                }, 500);
            }
        } catch (error) {
            console.error('Camera error:', error.name, error.message, error);
            const errorMsg = describeCameraError(error);
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + errorMsg;
            checkoutCaptureBtn.disabled = true;
            alert('Camera Error: ' + errorMsg + '\n\nPlease check your browser settings and try again.');
        }
    }
    
    function stopCheckoutCamera() {
        if (checkoutStream) {
            checkoutStream.getTracks().forEach(track => track.stop());
            checkoutStream = null;
        }
    }
    
    function resetCheckoutModal() {
        if (checkoutPreviewUrl) {
            URL.revokeObjectURL(checkoutPreviewUrl);
            checkoutPreviewUrl = null;
        }
        checkoutCamera.style.display = 'none';
        checkoutPreview.classList.add('d-none');
        checkoutCaptureBtn.classList.remove('d-none');
        checkoutRetakeBtn.classList.add('d-none');
        checkoutSubmitBtn.disabled = true;
        checkoutPhotoBlob = null;
        checkoutPhotoInput.value = '';
        // Clear location values
        checkoutLatitudeInput.value = '';
        checkoutLongitudeInput.value = '';
        checkoutCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...';
    }
    
    // Capture photo
    if (checkoutCaptureBtn) {
        checkoutCaptureBtn.addEventListener('click', function() {
            const context = checkoutCanvas.getContext('2d');
            checkoutCanvas.width = checkoutCamera.videoWidth;
            checkoutCanvas.height = checkoutCamera.videoHeight;
            context.drawImage(checkoutCamera, 0, 0);
            
            checkoutCanvas.toBlob(function(blob) {
                checkoutPhotoBlob = blob;
                if (checkoutPreviewUrl) {
                    URL.revokeObjectURL(checkoutPreviewUrl);
                }
                checkoutPreviewUrl = URL.createObjectURL(blob);
                checkoutPreview.src = checkoutPreviewUrl;
                
                // Hide camera, show preview
                checkoutCamera.style.display = 'none';
                checkoutPreview.classList.remove('d-none');
                checkoutCaptureBtn.classList.add('d-none');
                checkoutRetakeBtn.classList.remove('d-none');
                checkoutSubmitBtn.disabled = false;
                checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo captured successfully';
                
                // Stop camera
                stopCheckoutCamera();
            }, 'image/jpeg', 0.8);
        });
    }
    
    // Retake photo
    if (checkoutRetakeBtn) {
        checkoutRetakeBtn.addEventListener('click', function() {
            checkoutPreview.classList.add('d-none');
            checkoutCamera.style.display = 'block';
            checkoutCaptureBtn.classList.remove('d-none');
            checkoutRetakeBtn.classList.add('d-none');
            checkoutSubmitBtn.disabled = true;
            checkoutPhotoBlob = null;
            if (checkoutPreviewUrl) {
                URL.revokeObjectURL(checkoutPreviewUrl);
                checkoutPreviewUrl = null;
            }
            checkoutPhotoInput.value = '';
            initCheckoutCamera();
        });
    }

    if (checkoutUploadBtn) {
        checkoutUploadBtn.addEventListener('click', function() {
            stopCheckoutCamera();
            checkoutCaptureBtn.classList.add('d-none');
            checkoutCamera.style.display = 'none';
            checkoutRetakeBtn.classList.remove('d-none');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-upload me-1"></i>Select a photo using your device camera or gallery.';
            checkoutPhotoInput.click();
        });
    }

    if (checkoutPhotoInput) {
        checkoutPhotoInput.addEventListener('change', function(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }

            checkoutPhotoBlob = file;
            if (checkoutPreviewUrl) {
                URL.revokeObjectURL(checkoutPreviewUrl);
            }
            checkoutPreviewUrl = URL.createObjectURL(file);
            checkoutPreview.src = checkoutPreviewUrl;
            checkoutPreview.classList.remove('d-none');
            checkoutSubmitBtn.disabled = false;
            checkoutRetakeBtn.classList.remove('d-none');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo selected successfully.';
        });
    }
    
    // Submit check-out
    if (checkoutSubmitBtn) {
        checkoutSubmitBtn.addEventListener('click', function() {
            console.log('Check-out submit clicked');
            console.log('Photo blob:', checkoutPhotoBlob);
            console.log('Latitude:', checkoutLatitudeInput.value);
            console.log('Longitude:', checkoutLongitudeInput.value);
            
            if (!checkoutPhotoBlob) {
                alert('Please capture a photo first');
                return;
            }
            
            // Validate location coordinates are present
            if (!checkoutLatitudeInput.value || !checkoutLongitudeInput.value) {
                console.error('Location validation failed - coordinates missing');
                alert('Location access is required for check-out. Please enable location services and try again.');
                return;
            }
            
            // Create file from blob
            let fileToSubmit;
            if (checkoutPhotoBlob instanceof File) {
                fileToSubmit = checkoutPhotoBlob;
            } else {
                fileToSubmit = new File([checkoutPhotoBlob], 'checkout_photo.jpg', { type: 'image/jpeg' });
            }
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(fileToSubmit);
            checkoutPhotoInput.files = dataTransfer.files;
            
            console.log('Submitting check-out form with location:', {
                latitude: checkoutLatitudeInput.value,
                longitude: checkoutLongitudeInput.value
            });
            
            // Disable button and show loading
            checkoutSubmitBtn.disabled = true;
            checkoutSubmitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Processing...';
            
            // Submit form
            checkoutForm.submit();
        });
    }
});
  </script>
{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <style>
    .camera-preview {
      width: 100%;
      max-width: 500px;
      height: auto;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      background: #f8f9fa;
    }

    .camera-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 500px;
    }

    @media (max-width: 768px) {
      .camera-preview {
        max-width: 100%;
        border-radius: 8px;
      }

      .modal-lg {
        max-width: 95%;
      }
    }
  </style>
{% endblock %}
