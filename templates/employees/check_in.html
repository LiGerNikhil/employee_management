{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Attendance | Kwikster CRM{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-xl-8 col-lg-10 col-md-12">
      <div class="card">
        <div class="card-header text-center">
          <h5 class="card-title m-0">Attendance Management</h5>
          <small class="text-muted">Manage your daily check-in and check-out</small>
        </div>

        <div class="card-body">
          {% if messages %}
            <div class="mb-4">
              {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-secondary{% endif %} mb-2" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="text-center mb-4">
            <div class="avatar avatar-xl mb-3 mx-auto">
              {% if employee.profile_picture %}
                <img src="{{ employee.profile_picture.url }}" alt="{{ employee.name }}" class="rounded-circle">
              {% else %}
                <span class="avatar-initial rounded-circle bg-label-primary">
                  {{ employee.name|slice:":1"|upper }}
                </span>
              {% endif %}
            </div>
            <h4 class="mb-2">Welcome, {{ employee.name }}!</h4>
            <p class="text-muted mb-4">
              Manage your attendance and view your monthly calendar
            </p>

            {% if today_attendance %}
              <div class="alert alert-success">
                <h6 class="alert-heading mb-2">
                  <i class="icon-base bx bx-check-circle me-1"></i>Today's Attendance
                </h6>
                <p class="mb-1">
                  <strong>Date:</strong> {{ today_attendance.date|date:"d M Y, l" }}
                </p>
                <p class="mb-1">
                  <strong>Check-in Time:</strong> {{ today_attendance.check_in_time|date:"H:i:s" }}
                </p>
                {% if today_attendance.check_out_time %}
                  <p class="mb-0">
                    <strong>Check-out Time:</strong> {{ today_attendance.check_out_time|date:"H:i:s" }}
                  </p>
                {% endif %}
              </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="d-flex justify-content-center gap-3 mb-4">
              {% if not has_checked_in_today %}
                <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#checkinModal">
                  <i class="bx bx-log-in me-1"></i>Check In
                </button>
              {% elif today_attendance and not today_attendance.check_out_time %}
                <button type="button" class="btn btn-danger btn-lg" data-bs-toggle="modal" data-bs-target="#checkoutModal">
                  <i class="bx bx-log-out me-1"></i>Check Out
                </button>
              {% else %}
                <div class="alert alert-info">
                  <i class="bx bx-info-circle me-1"></i>
                  You have completed your attendance for today.
                </div>
              {% endif %}
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-center gap-3">
              <a href="{% url 'employees:employee_dashboard' %}" class="btn btn-primary">
                <i class="icon-base bx bx-home me-1"></i>Back to Dashboard
              </a>
              <a href="{% url 'employees:employee_profile' %}" class="btn btn-outline-primary">
                <i class="icon-base bx bx-user me-1"></i>View Profile
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Check-In Modal -->
  <div class="modal fade" id="checkinModal" tabindex="-1" aria-labelledby="checkinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title text-white" id="checkinModalLabel">
            <i class="bx bx-log-in me-2"></i>Check In
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bx bx-camera me-1"></i>
            <strong>Photo Verification Required:</strong> Please capture a photo to complete your check-in.
          </div>

          <div class="text-center">
            <div class="camera-container mb-3">
              <video id="checkin-camera" class="camera-preview" autoplay playsinline muted style="display: none;"></video>
              <canvas id="checkin-canvas" class="d-none"></canvas>
              <img id="checkin-preview" class="camera-preview d-none" alt="Preview">
            </div>

            <div class="mb-3">
              <button type="button" id="checkin-capture-btn" class="btn btn-success btn-lg" disabled>
                <i class="bx bx-camera me-1"></i>Capture Photo
              </button>
              <button type="button" id="checkin-retake-btn" class="btn btn-outline-secondary btn-lg d-none">
                <i class="bx bx-refresh me-1"></i>Retake
              </button>
            </div>

            <div id="checkin-camera-status" class="text-muted small mb-3">
              <i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...
            </div>
          </div>

          <form id="checkin-form" method="post" enctype="multipart/form-data" class="d-none">
            {% csrf_token %}
            <input type="file" name="check_in_photo" id="checkin-photo-input" accept="image/*" required class="d-none">
            <input type="hidden" name="latitude" id="checkin-latitude-input">
            <input type="hidden" name="longitude" id="checkin-longitude-input">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bx bx-x me-1"></i>Cancel
          </button>
          <button type="button" id="checkin-submit-btn" class="btn btn-success" disabled>
            <i class="bx bx-check-circle me-1"></i>Complete Check-In
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Check-Out Modal -->
  <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title text-white" id="checkoutModalLabel">
            <i class="bx bx-log-out me-2"></i>Check Out
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="bx bx-camera me-1"></i>
            <strong>Photo Verification Required:</strong> Please capture a photo to complete your check-out.
          </div>

          <div class="text-center">
            <div class="camera-container mb-3">
              <video id="checkout-camera" class="camera-preview" autoplay playsinline muted style="display: none;"></video>
              <canvas id="checkout-canvas" class="d-none"></canvas>
              <img id="checkout-preview" class="camera-preview d-none" alt="Preview">
            </div>

            <div class="mb-3">
              <button type="button" id="checkout-capture-btn" class="btn btn-danger btn-lg" disabled>
                <i class="bx bx-camera me-1"></i>Capture Photo
              </button>
              <button type="button" id="checkout-retake-btn" class="btn btn-outline-secondary btn-lg d-none">
                <i class="bx bx-refresh me-1"></i>Retake
              </button>

            </div>

            <div id="checkout-camera-status" class="text-muted small mb-3">
              <i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...
            </div>
          </div>

          <form id="checkout-form" method="post" action="{% url 'employees:check_out' %}" enctype="multipart/form-data" class="d-none">
            {% csrf_token %}
            <input type="file" name="check_out_photo" id="checkout-photo-input" accept="image/*" required class="d-none">
            <input type="hidden" name="latitude" id="checkout-latitude-input">
            <input type="hidden" name="longitude" id="checkout-longitude-input">
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bx bx-x me-1"></i>Cancel
          </button>
          <button type="button" id="checkout-submit-btn" class="btn btn-danger" disabled>
            <i class="bx bx-log-out me-1"></i>Complete Check-Out
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_js %}
  {{ block.super }}
  <script>
document.addEventListener('DOMContentLoaded', function() {
    // ===========================
    // CHECK-IN MODAL FUNCTIONALITY
    // ===========================
    const checkinModal = document.getElementById('checkinModal');
    const checkinCamera = document.getElementById('checkin-camera');
    const checkinCanvas = document.getElementById('checkin-canvas');
    const checkinPreview = document.getElementById('checkin-preview');
    const checkinCaptureBtn = document.getElementById('checkin-capture-btn');
    const checkinRetakeBtn = document.getElementById('checkin-retake-btn');
    const checkinUploadBtn = document.getElementById('checkin-upload-btn');
    const checkinSubmitBtn = document.getElementById('checkin-submit-btn');
    const checkinForm = document.getElementById('checkin-form');
    const checkinPhotoInput = document.getElementById('checkin-photo-input');
    const checkinCameraStatus = document.getElementById('checkin-camera-status');
    const checkinLatitudeInput = document.getElementById('checkin-latitude-input');
    const checkinLongitudeInput = document.getElementById('checkin-longitude-input');
    
    let checkinStream = null;
    let checkinPhotoBlob = null;
    let checkinPreviewUrl = null;

    function describeCameraError(error) {
        if (!error) {
            return 'Camera access failed for an unknown reason.';
        }
        const name = error.name || '';
        const message = error.message || '';
        switch (name) {
            case 'NotAllowedError':
            case 'PermissionDeniedError':
                return 'Camera permission was denied. Please allow camera access in your browser settings and try again.';
            case 'NotFoundError':
            case 'DevicesNotFoundError':
                return 'No camera device was found. Connect a camera and try again.';
            case 'NotReadableError':
            case 'TrackStartError':
                return 'The camera is already in use by another application. Close other programs using the camera and retry.';
            case 'OverconstrainedError':
            case 'ConstraintNotSatisfiedError':
                return 'The requested camera settings are not supported. We will try a more compatible setup automatically.';
            case 'SecurityError':
                if (window.isSecureContext === false) {
                    return 'Camera access requires HTTPS or localhost. Please use a secure connection.';
                }
                return 'Camera access is blocked by browser security settings.';
            default:
                if (message && message.toLowerCase().includes('insecure')) {
                    return 'Camera access requires HTTPS or localhost. Please reload the page over a secure connection.';
                }
                return message || 'Unable to access camera. Please allow permissions and try again.';
        }
    }

    async function acquireCameraStream() {
        const attempts = [
            { video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: 'user' }, audio: false },
            { video: { facingMode: 'user' }, audio: false },
            { video: true }
        ];

        let lastError = null;
        for (const constraints of attempts) {
            try {
                return await navigator.mediaDevices.getUserMedia(constraints);
            } catch (err) {
                lastError = err;
            }
        }
        throw lastError;
    }

    // Get user's current location for check-in
    function getCheckinLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation is not supported by your browser'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    let errorMessage = 'Unable to retrieve your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    reject(new Error(errorMessage));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }
    
    // Initialize camera when modal is shown
    if (checkinModal) {
        checkinModal.addEventListener('shown.bs.modal', function() {
            // Kick off camera immediately
            initCheckinCamera();

            // Request location in parallel
            getCheckinLocation()
                .then(coords => {
                    checkinLatitudeInput.value = coords.latitude;
                    checkinLongitudeInput.value = coords.longitude;
                    console.log('Check-in location obtained:', coords);
                })
                .catch(error => {
                    console.error('Location error:', error);
                    alert(error.message + '\n\nLocation access is required for check-in. Please enable location services and try again.');
                });
        });
        
        checkinModal.addEventListener('hidden.bs.modal', function() {
            stopCheckinCamera();
            resetCheckinModal();
        });
    }
    
    async function initCheckinCamera() {
        console.log('Initializing check-in camera...');

        if (!window.isSecureContext) {
            const msg = 'Camera access requires HTTPS or running the site on localhost. Please reload via https:// or http://localhost.';
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
            console.error(msg);
            checkinCaptureBtn.disabled = true;
            return;
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('MediaDevices API not supported');
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Camera not supported on this device';
            checkinCaptureBtn.disabled = true;
            return;
        }

        if (navigator.permissions && navigator.permissions.query) {
            try {
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    const msg = 'Browser camera permission is blocked. Please enable camera access in your browser settings and reload the page.';
                    checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
                    checkinCaptureBtn.disabled = true;
                    return;
                }
            } catch (permErr) {
                console.warn('Unable to query camera permissions:', permErr);
            }
        }

        checkinCaptureBtn.disabled = true;
        checkinCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Requesting camera access...';

        try {
            // Stop existing stream before requesting a new one
            stopCheckinCamera();

            const stream = await acquireCameraStream();

            checkinStream = stream;
            checkinCamera.srcObject = stream;
            checkinCamera.style.display = 'block';
            
            // Force play immediately
            try {
                await checkinCamera.play();
                console.log('Check-in camera playing');
                checkinCaptureBtn.disabled = false;
                checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
            } catch (playError) {
                console.error('Error playing camera:', playError);
                // Try one more time after a short delay
                setTimeout(async () => {
                    try {
                        await checkinCamera.play();
                        checkinCaptureBtn.disabled = false;
                        checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
                    } catch (e) {
                        checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Error starting camera';
                    }
                }, 500);
            }
        } catch (error) {
            console.error('Camera error:', error.name, error.message, error);
            const errorMsg = describeCameraError(error);
            checkinCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + errorMsg;
            checkinCaptureBtn.disabled = true;
        }
    }
    
    function stopCheckinCamera() {
        if (checkinStream) {
            checkinStream.getTracks().forEach(track => track.stop());
            checkinStream = null;
        }
    }
    
    function resetCheckinModal() {
        if (checkinPreviewUrl) {
            URL.revokeObjectURL(checkinPreviewUrl);
            checkinPreviewUrl = null;
        }
        checkinCamera.style.display = 'none';
        checkinPreview.classList.add('d-none');
        checkinCaptureBtn.classList.remove('d-none');
        checkinRetakeBtn.classList.add('d-none');
        checkinSubmitBtn.disabled = true;
        checkinPhotoBlob = null;
        checkinPhotoInput.value = '';
        // Clear location values
        checkinLatitudeInput.value = '';
        checkinLongitudeInput.value = '';
        checkinCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...';
    }
    
    // Capture photo
    if (checkinCaptureBtn) {
        checkinCaptureBtn.addEventListener('click', function() {
            const context = checkinCanvas.getContext('2d');
            checkinCanvas.width = checkinCamera.videoWidth;
            checkinCanvas.height = checkinCamera.videoHeight;
            context.drawImage(checkinCamera, 0, 0);
            
            checkinCanvas.toBlob(function(blob) {
                checkinPhotoBlob = blob;
                if (checkinPreviewUrl) {
                    URL.revokeObjectURL(checkinPreviewUrl);
                }
                checkinPreviewUrl = URL.createObjectURL(blob);
                checkinPreview.src = checkinPreviewUrl;
                
                // Hide camera, show preview
                checkinCamera.style.display = 'none';
                checkinPreview.classList.remove('d-none');
                checkinCaptureBtn.classList.add('d-none');
                checkinRetakeBtn.classList.remove('d-none');
                checkinSubmitBtn.disabled = false;
                checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo captured successfully';
                
                // Stop camera
                stopCheckinCamera();
            }, 'image/jpeg', 0.8);
        });
    }
    
    // Retake photo
    if (checkinRetakeBtn) {
        checkinRetakeBtn.addEventListener('click', function() {
            checkinPreview.classList.add('d-none');
            checkinCamera.style.display = 'block';
            checkinCaptureBtn.classList.remove('d-none');
            checkinRetakeBtn.classList.add('d-none');
            checkinSubmitBtn.disabled = true;
            checkinPhotoBlob = null;
            if (checkinPreviewUrl) {
                URL.revokeObjectURL(checkinPreviewUrl);
                checkinPreviewUrl = null;
            }
            checkinPhotoInput.value = '';
            initCheckinCamera();
        });
    }

    if (checkinUploadBtn) {
        checkinUploadBtn.addEventListener('click', function() {
            stopCheckinCamera();
            checkinCaptureBtn.classList.add('d-none');
            checkinCamera.style.display = 'none';
            checkinRetakeBtn.classList.remove('d-none');
            checkinCameraStatus.innerHTML = '<i class="bx bx-upload me-1"></i>Select a photo using your device camera or gallery.';
            checkinPhotoInput.click();
        });
    }

    if (checkinPhotoInput) {
        checkinPhotoInput.addEventListener('change', function(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }

            checkinPhotoBlob = file;
            if (checkinPreviewUrl) {
                URL.revokeObjectURL(checkinPreviewUrl);
            }
            checkinPreviewUrl = URL.createObjectURL(file);
            checkinPreview.src = checkinPreviewUrl;
            checkinPreview.classList.remove('d-none');
            checkinSubmitBtn.disabled = false;
            checkinRetakeBtn.classList.remove('d-none');
            checkinCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo selected successfully.';
        });
    }
    
    // Submit check-in
    if (checkinSubmitBtn) {
        checkinSubmitBtn.addEventListener('click', function() {
            console.log('Check-in submit clicked');
            console.log('Photo blob:', checkinPhotoBlob);
            console.log('Latitude:', checkinLatitudeInput.value);
            console.log('Longitude:', checkinLongitudeInput.value);
            
            if (!checkinPhotoBlob) {
                alert('Please capture a photo first');
                return;
            }
            
            // Validate location coordinates are present
            if (!checkinLatitudeInput.value || !checkinLongitudeInput.value) {
                console.error('Location validation failed - coordinates missing');
                alert('Location access is required for check-in. Please enable location services and try again.');
                return;
            }
            
            // Create file from blob
            let fileToSubmit;
            if (checkinPhotoBlob instanceof File) {
                fileToSubmit = checkinPhotoBlob;
            } else {
                fileToSubmit = new File([checkinPhotoBlob], 'checkin_photo.jpg', { type: 'image/jpeg' });
            }
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(fileToSubmit);
            checkinPhotoInput.files = dataTransfer.files;
            
            console.log('Submitting check-in form with location:', {
                latitude: checkinLatitudeInput.value,
                longitude: checkinLongitudeInput.value
            });
            
            // Disable button and show loading
            checkinSubmitBtn.disabled = true;
            checkinSubmitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Processing...';
            
            // Submit form
            checkinForm.submit();
        });
    }

    // ===========================
    // CHECK-OUT MODAL FUNCTIONALITY
    // ===========================
    const checkoutModal = document.getElementById('checkoutModal');
    const checkoutCamera = document.getElementById('checkout-camera');
    const checkoutCanvas = document.getElementById('checkout-canvas');
    const checkoutPreview = document.getElementById('checkout-preview');
    const checkoutCaptureBtn = document.getElementById('checkout-capture-btn');
    const checkoutRetakeBtn = document.getElementById('checkout-retake-btn');
    const checkoutUploadBtn = document.getElementById('checkout-upload-btn');
    const checkoutSubmitBtn = document.getElementById('checkout-submit-btn');
    const checkoutForm = document.getElementById('checkout-form');
    const checkoutPhotoInput = document.getElementById('checkout-photo-input');
    const checkoutCameraStatus = document.getElementById('checkout-camera-status');
    const checkoutLatitudeInput = document.getElementById('checkout-latitude-input');
    const checkoutLongitudeInput = document.getElementById('checkout-longitude-input');
    
    let checkoutStream = null;
    let checkoutPhotoBlob = null;
    let checkoutPreviewUrl = null;
    
    // Get user's current location for checkout
    function getCheckoutLocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocation is not supported by your browser'));
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                },
                (error) => {
                    let errorMessage = 'Unable to retrieve your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    reject(new Error(errorMessage));
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }
    
    // Initialize camera when modal is shown
    if (checkoutModal) {
        checkoutModal.addEventListener('shown.bs.modal', function() {
            // Start camera immediately
            initCheckoutCamera();

            // Request location concurrently
            getCheckoutLocation()
                .then(coords => {
                    checkoutLatitudeInput.value = coords.latitude;
                    checkoutLongitudeInput.value = coords.longitude;
                    console.log('Checkout location obtained:', coords);
                })
                .catch(error => {
                    console.error('Location error:', error);
                    alert(error.message + '\n\nLocation access is required for check-out. Please enable location services and try again.');
                });
        });
        
        checkoutModal.addEventListener('hidden.bs.modal', function() {
            stopCheckoutCamera();
            resetCheckoutModal();
        });
    }
    
    async function initCheckoutCamera() {
        console.log('Initializing checkout camera...');

        if (!window.isSecureContext) {
            const msg = 'Camera access requires HTTPS or running the site on localhost. Please reload via https:// or http://localhost.';
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
            console.error(msg);
            checkoutCaptureBtn.disabled = true;
            return;
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            console.error('MediaDevices API not supported');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Camera not supported on this device';
            checkoutCaptureBtn.disabled = true;
            return;
        }

        if (navigator.permissions && navigator.permissions.query) {
            try {
                const cameraPermission = await navigator.permissions.query({ name: 'camera' });
                if (cameraPermission.state === 'denied') {
                    const msg = 'Browser camera permission is blocked. Please enable camera access in your browser settings and reload the page.';
                    checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + msg;
                    checkoutCaptureBtn.disabled = true;
                    return;
                }
            } catch (permErr) {
                console.warn('Unable to query camera permissions:', permErr);
            }
        }

        checkoutCaptureBtn.disabled = true;
        checkoutCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Requesting camera access...';

        try {
            // Stop existing stream to avoid conflicts
            stopCheckoutCamera();

            const stream = await acquireCameraStream();

            checkoutStream = stream;
            checkoutCamera.srcObject = stream;
            checkoutCamera.style.display = 'block';
            
            // Force play immediately
            try {
                await checkoutCamera.play();
                console.log('Checkout camera playing');
                checkoutCaptureBtn.disabled = false;
                checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
            } catch (playError) {
                console.error('Error playing camera:', playError);
                // Try one more time after a short delay
                setTimeout(async () => {
                    try {
                        await checkoutCamera.play();
                        checkoutCaptureBtn.disabled = false;
                        checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Camera ready';
                    } catch (e) {
                        checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>Error starting camera';
                    }
                }, 500);
            }
        } catch (error) {
            console.error('Camera error:', error.name, error.message, error);
            const errorMsg = describeCameraError(error);
            checkoutCameraStatus.innerHTML = '<i class="bx bx-error-circle me-1 text-danger"></i>' + errorMsg;
            checkoutCaptureBtn.disabled = true;
            alert('Camera Error: ' + errorMsg + '\n\nPlease check your browser settings and try again.');
        }
    }
    
    function stopCheckoutCamera() {
        if (checkoutStream) {
            checkoutStream.getTracks().forEach(track => track.stop());
            checkoutStream = null;
        }
    }
    
    function resetCheckoutModal() {
        if (checkoutPreviewUrl) {
            URL.revokeObjectURL(checkoutPreviewUrl);
            checkoutPreviewUrl = null;
        }
        checkoutCamera.style.display = 'none';
        checkoutPreview.classList.add('d-none');
        checkoutCaptureBtn.classList.remove('d-none');
        checkoutRetakeBtn.classList.add('d-none');
        checkoutSubmitBtn.disabled = true;
        checkoutPhotoBlob = null;
        checkoutPhotoInput.value = '';
        // Clear location values
        checkoutLatitudeInput.value = '';
        checkoutLongitudeInput.value = '';
        checkoutCameraStatus.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Initializing camera...';
    }
    
    // Capture photo
    if (checkoutCaptureBtn) {
        checkoutCaptureBtn.addEventListener('click', function() {
            const context = checkoutCanvas.getContext('2d');
            checkoutCanvas.width = checkoutCamera.videoWidth;
            checkoutCanvas.height = checkoutCamera.videoHeight;
            context.drawImage(checkoutCamera, 0, 0);
            
            checkoutCanvas.toBlob(function(blob) {
                checkoutPhotoBlob = blob;
                if (checkoutPreviewUrl) {
                    URL.revokeObjectURL(checkoutPreviewUrl);
                }
                checkoutPreviewUrl = URL.createObjectURL(blob);
                checkoutPreview.src = checkoutPreviewUrl;
                
                // Hide camera, show preview
                checkoutCamera.style.display = 'none';
                checkoutPreview.classList.remove('d-none');
                checkoutCaptureBtn.classList.add('d-none');
                checkoutRetakeBtn.classList.remove('d-none');
                checkoutSubmitBtn.disabled = false;
                checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo captured successfully';
                
                // Stop camera
                stopCheckoutCamera();
            }, 'image/jpeg', 0.8);
        });
    }
    
    // Retake photo
    if (checkoutRetakeBtn) {
        checkoutRetakeBtn.addEventListener('click', function() {
            checkoutPreview.classList.add('d-none');
            checkoutCamera.style.display = 'block';
            checkoutCaptureBtn.classList.remove('d-none');
            checkoutRetakeBtn.classList.add('d-none');
            checkoutSubmitBtn.disabled = true;
            checkoutPhotoBlob = null;
            if (checkoutPreviewUrl) {
                URL.revokeObjectURL(checkoutPreviewUrl);
                checkoutPreviewUrl = null;
            }
            checkoutPhotoInput.value = '';
            initCheckoutCamera();
        });
    }

    if (checkoutUploadBtn) {
        checkoutUploadBtn.addEventListener('click', function() {
            stopCheckoutCamera();
            checkoutCaptureBtn.classList.add('d-none');
            checkoutCamera.style.display = 'none';
            checkoutRetakeBtn.classList.remove('d-none');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-upload me-1"></i>Select a photo using your device camera or gallery.';
            checkoutPhotoInput.click();
        });
    }

    if (checkoutPhotoInput) {
        checkoutPhotoInput.addEventListener('change', function(event) {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                return;
            }

            checkoutPhotoBlob = file;
            if (checkoutPreviewUrl) {
                URL.revokeObjectURL(checkoutPreviewUrl);
            }
            checkoutPreviewUrl = URL.createObjectURL(file);
            checkoutPreview.src = checkoutPreviewUrl;
            checkoutPreview.classList.remove('d-none');
            checkoutSubmitBtn.disabled = false;
            checkoutRetakeBtn.classList.remove('d-none');
            checkoutCameraStatus.innerHTML = '<i class="bx bx-check-circle me-1 text-success"></i>Photo selected successfully.';
        });
    }
    
    // Submit check-out
    if (checkoutSubmitBtn) {
        checkoutSubmitBtn.addEventListener('click', function() {
            console.log('Check-out submit clicked');
            console.log('Photo blob:', checkoutPhotoBlob);
            console.log('Latitude:', checkoutLatitudeInput.value);
            console.log('Longitude:', checkoutLongitudeInput.value);
            
            if (!checkoutPhotoBlob) {
                alert('Please capture a photo first');
                return;
            }
            
            // Validate location coordinates are present
            if (!checkoutLatitudeInput.value || !checkoutLongitudeInput.value) {
                console.error('Location validation failed - coordinates missing');
                alert('Location access is required for check-out. Please enable location services and try again.');
                return;
            }
            
            // Create file from blob
            let fileToSubmit;
            if (checkoutPhotoBlob instanceof File) {
                fileToSubmit = checkoutPhotoBlob;
            } else {
                fileToSubmit = new File([checkoutPhotoBlob], 'checkout_photo.jpg', { type: 'image/jpeg' });
            }
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(fileToSubmit);
            checkoutPhotoInput.files = dataTransfer.files;
            
            console.log('Submitting check-out form with location:', {
                latitude: checkoutLatitudeInput.value,
                longitude: checkoutLongitudeInput.value
            });
            
            // Disable button and show loading
            checkoutSubmitBtn.disabled = true;
            checkoutSubmitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin me-1"></i>Processing...';
            
            // Submit form
            checkoutForm.submit();
        });
    }
});
  </script>
{% endblock %}

{% block vendor_css %}
  {{ block.super }}
  <style>
    .camera-preview {
      width: 100%;
      max-width: 500px;
      height: auto;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      background: #f8f9fa;
    }

    .camera-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 500px;
    }

    @media (max-width: 768px) {
      .camera-preview {
        max-width: 100%;
        border-radius: 8px;
      }

      .modal-lg {
        max-width: 95%;
      }
    }
  </style>
{% endblock %}
